<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase</title>

</head>

<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        import { getDatabase, ref, child, get, onValue, set, update, push, remove } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDh2c8ZJcSZsqVU__MqfQvLwW29JDYa88g",
            authDomain: "lab10-62130500018.firebaseapp.com",
            databaseURL: "https://lab10-62130500018-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lab10-62130500018",
            storageBucket: "lab10-62130500018.appspot.com",
            messagingSenderId: "578425799266",
            appId: "1:578425799266:web:c5e90ac8b7744f2dff473b",
            measurementId: "G-R4W29QXL1P",
            databaseURL: "https://lab10-62130500018-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        //****show list of key
        window.showList = function showList() {
            get(child(ref(db), 'users')).then((snapshot) => {
                var x = snapshot.val();
                let dropdown = document.getElementById('keyList');
                for (let i = dropdown.length; i>1; i--) {
                    dropdown.remove(dropdown.length-1);
                }
                var y = Object.keys(x);
                for (let i = 0; i < y.length; i++) {
                    var option = document.createElement("option");
                    option.text = y[i];
                    option.value = y[i];
                    dropdown.add(option);
                }
            });
        }

        //***Show value of selected key
        window.showValue = function showValue() {
            let dropdown = document.getElementById('keyList');
            onValue(ref(db, 'users/' + dropdown.value), (snapshot) => {
                var obj = snapshot.val();
                document.getElementById("readName").innerHTML = obj.name;
                document.getElementById("readAddress").innerHTML = obj.address;
                document.getElementById("readTel").innerHTML = obj.tel;
            });            
            onValue(ref(db, 'lastPost/' + dropdown.value), (snapshot) =>{
                var obj = snapshot.val();
                document.getElementById("readMessage").innerHTML = obj.lastMsg;
            }); 
        }

        //***Update value of selected key
        window.updateData = function updateData() {
            var x = document.getElementById("newTel").value;
            var dropdown = document.getElementById('keyList');
            var bid = dropdown.value;
            set(ref(db,'users/'+bid+'/tel'), x );
        }

        window.updatePost = function updatePost() {
            var x = document.getElementById("newPost").value;
            let value = {lastMsg:x , name:document.getElementById("readName").innerHTML};
            var dropdown = document.getElementById('keyList');
            var bid = dropdown.value;
            let allpost = {msg:x , newDate:Date.now() , uid:bid}
            const updates = {};
            updates['lastPost/' + bid] = value;
            update(ref(db), updates);
            const newPostKey = push(child(ref(db), 'allPost')).key;
            const updatesallPost = {};
            updatesallPost['allPost/' + newPostKey] = allpost;
            update(ref(db), updatesallPost);

        }

        //***Write new date with manual key
        window.writeData1 = function writeData1() {
            var x = document.getElementById("bid").value;
            var y = document.getElementById("bname").value;
            var z = document.getElementById("bprice").value;
            const newData = { name:y , price:z };
            const updates = {};
            updates['books/' + x] = newData;
            update(ref(db), updates);
        }

        //***Write new date with auto key
        window.writeData2 = function writeData2() {
            var y = document.getElementById("bname").value;
            var z = document.getElementById("bprice").value;
            const newData = { name:y , price:z };
            const newPostKey = push(child(ref(db), 'books')).key;
            const updates = {};
            updates['books/' + newPostKey] = newData;
            update(ref(db), updates);
        }

        //***delete seleted key
        window.delData = function delData() {
            const updates = {};
            var dropdown = document.getElementById('keyList');
            var bid = dropdown.value;
            remove(child(ref(db), 'allPost/'+bid));
        }
    </script>

    <h1>READ</h1>
    <select id="keyList" size="5" onchange="showValue()" >
        <option>-- Choose following key --</option>
    </select>
    <button onclick="showList()">Refresh List</button>
    <br>
    Name is <b id="readName"></b><br>
    Address is <b id="readAddress"></b><br>
    Tel is <b id="readTel"></b>
    <br><hr>

    <h1>Lastpost</h1>
    msg is : <b id ="readMessage"></b><br>
    

    <h1>Update users tel</h1>
    <input type="text" id="newTel" value="Enter new Tel">
    <button onclick="updateData()">update</button>
    <br><hr>

    <h1>Add new post</h1>
    <input type="text" id="newPost" value="Enter new Post">
    <button onclick="updatePost()">update</button>
    <br><hr>

    <h1>Delete</h1>
    <button onclick="delData()">Delete</button>
    <br><hr>

    

</body>
</html>